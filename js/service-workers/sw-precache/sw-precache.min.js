"use strict";var crypto=require("crypto"),defaults=require("lodash.defaults"),externalFunctions=require("./functions.js"),fs=require("fs"),glob=require("glob"),mkdirp=require("mkdirp"),path=require("path"),prettyBytes=require("pretty-bytes"),template=require("lodash.template"),util=require("util");require("es6-promise").polyfill();var VERSION="v3";function absolutePath(e){return path.resolve(process.cwd(),e)}function getFileAndSizeAndHashForFile(e){var t=fs.statSync(e);if(t.isFile()){var r=fs.readFileSync(e);return{file:e,size:t.size,hash:getHash(r)}}return null}function getFilesAndSizesAndHashesForGlobPattern(e,t){return glob.sync(e.replace(path.sep,"/")).map(function(e){return t===absolutePath(e)?null:getFileAndSizeAndHashForFile(e)}).filter(function(e){return null!==e})}function getHash(e){var t=crypto.createHash("md5");return t.update(e),t.digest("hex")}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function generateRuntimeCaching(e){return e.reduce(function(e,t){var r;if(t.default)r=util.format("\ntoolbox.router.default = toolbox.%s;",t.default);else{var i=t.urlPattern;if("string"==typeof i&&(i=JSON.stringify(i)),!(i instanceof RegExp||"string"==typeof i))throw new Error("runtimeCaching.urlPattern must be a string or RegExp");r=util.format("\ntoolbox.router.%s(%s, %s, %s);",t.method||"get",i,("string"==typeof t.handler?"toolbox.":"")+t.handler,stringifyToolboxOptions(t.options))}return e+r},"")}function stringifyToolboxOptions(e){e=e||{};var t=JSON.stringify(e);return e.origin instanceof RegExp&&(t=t.replace(/("origin":)\{\}/,"$1"+e.origin)),e.successResponses instanceof RegExp&&(t=t.replace(/("successResponses":)\{\}/,"$1"+e.successResponses)),t}function generate(u,p){return new Promise(function(i,n){u=defaults(u||{},{cacheId:"",clientsClaim:!0,directoryIndex:"index.html",dontCacheBustUrlsMatching:null,dynamicUrlToDependencies:{},handleFetch:!0,ignoreUrlParametersMatching:[/^utm_/],importScripts:[],logger:console.log,maximumFileSizeToCacheInBytes:2097152,navigateFallback:"",navigateFallbackWhitelist:[],replacePrefix:"",skipWaiting:!0,staticFileGlobs:[],stripPrefix:"",stripPrefixMulti:{},templateFilePath:path.join(path.dirname(fs.realpathSync(__filename)),"..","service-worker.tmpl"),verbose:!1}),Array.isArray(u.ignoreUrlParametersMatching)||(u.ignoreUrlParametersMatching=[u.ignoreUrlParametersMatching]);var a,s,o={},l=0;if(u.stripPrefixMulti[u.stripPrefix]=u.replacePrefix,u.staticFileGlobs.forEach(function(e){getFilesAndSizesAndHashesForGlobPattern(e,u.outputFilePath).forEach(function(e){if(e.size<=u.maximumFileSizeToCacheInBytes){var t=e.file.replace(new RegExp("^("+Object.keys(u.stripPrefixMulti).map(escapeRegExp).join("|")+")"),function(e){return u.stripPrefixMulti[e]}).replace(path.sep,"/");o[t]=e.hash,u.verbose&&u.logger(util.format('Caching static resource "%s" (%s)',e.file,prettyBytes(e.size))),l+=e.size}else u.logger(util.format('Skipping static resource "%s" (%s) - max size is %s',e.file,prettyBytes(e.size),prettyBytes(u.maximumFileSizeToCacheInBytes)))})}),Object.keys(u.dynamicUrlToDependencies).forEach(function(r){var e=u.dynamicUrlToDependencies[r],t="string"==typeof e,i=Buffer.isBuffer(e);if(!Array.isArray(e)&&!t&&!i)throw Error(util.format("The value for the dynamicUrlToDependencies.%s option must be an Array, a Buffer, or a String.",r));if(t||i)l+=e.length,o[r]=getHash(e);else{var n=e.sort().map(function(t){try{return getFileAndSizeAndHashForFile(t)}catch(e){throw"ENOENT"===e.code&&u.logger(util.format("%s was listed as a dependency for dynamic URL %s, but the file does not exist. Either remove the entry as a dependency, or correct the path to the file.",t,r)),e}}),a="";n.forEach(function(e){l+=e.size,a+=e.hash}),o[r]=getHash(a)}u.verbose&&(t?u.logger(util.format('Caching dynamic URL "%s" with dependency on user-supplied string',r)):i?u.logger(util.format('Caching dynamic URL "%s" with dependency on user-supplied buffer',r)):u.logger(util.format('Caching dynamic URL "%s" with dependencies on %j',r,e)))}),u.runtimeCaching){a=generateRuntimeCaching(u.runtimeCaching);var e=require.resolve("sw-toolbox/sw-toolbox.js");s=fs.readFileSync(e,"utf8").replace("//# sourceMappingURL=sw-toolbox.js.map","")}var t=Object.keys(o),c=t.sort().map(function(e){return[e,o[e]]});u.logger(util.format("Total precache size is about %s for %d resources.",prettyBytes(l),t.length)),fs.readFile(u.templateFilePath,"utf8",function(e,t){if(e)return p&&p(e),n(e);var r=template(t)({cacheId:u.cacheId,clientsClaim:u.clientsClaim,directoryIndex:u.directoryIndex||"",dontCacheBustUrlsMatching:u.dontCacheBustUrlsMatching||!1,externalFunctions:externalFunctions,handleFetch:u.handleFetch,ignoreUrlParametersMatching:u.ignoreUrlParametersMatching,importScripts:u.importScripts?u.importScripts.map(JSON.stringify).join(","):null,navigateFallback:u.navigateFallback||"",navigateFallbackWhitelist:JSON.stringify(u.navigateFallbackWhitelist.map(function(e){return e.source})),precacheConfig:JSON.stringify(c),runtimeCaching:a,skipWaiting:u.skipWaiting,swToolboxCode:s,version:VERSION});p&&p(null,r),i(r)})})}function write(n,e,a){return new Promise(function(r,i){function t(e,t){e?i(e):r(t),a&&a(e,t)}mkdirp.sync(path.dirname(n)),e.outputFilePath=absolutePath(n),generate(e).then(function(e){fs.writeFile(n,e,t)},t)})}module.exports={generate:generate,write:write},"swprecache-test"===process.env.NODE_ENV&&(module.exports.generateRuntimeCaching=generateRuntimeCaching);
//# sourceMappingURL=sw-precache.min.js.map
